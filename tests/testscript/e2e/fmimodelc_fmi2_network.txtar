env NAME=fmimodelc_network_fmu
env IMPORTER=dse/build/_out/importer/fmuImporter
env FMU_DIR=dse/build/_out/examples/fmimodelc/fmi2


# TEST: FMI ModelC with Network FMU using FMIv2
exec sh -e $WORK/test.sh

stdout 'Importer: Loading FMU: binaries/linux64/libfmi2modelcfmu.so'
stdout 'Runtime: Simulation Path: resources/sim'
stdout 'Runtime: Simulation YAML: resources/sim/data/simulation.yaml'
stdout 'Runtime: Model: fmu'
stdout 'Loading dynamic model: resources/sim/lib/libfmimodelctarget.so'
stdout 'Configure Channel: scalar_vector'
stdout 'Configure Channel: network_vector'
stdout 'ModelCFmu: Runtime Environment Variables:'
stdout 'ModelCFmu:   set envar: name=TARGET_INST__MSG, value=Bar'
stdout 'ModelCFmu:   set envar: name=MSG, value=Foo'
stdout 'ModelCFmu:   Scalar: input=0, output=1'
stdout 'ModelCFmu:   Binary: rx=4, tx=4'
stdout 'ModelCFmu:   Encoding: enc=8, dec=8'

stdout 'Importer: Calling fmi2DoStep\(\): model_time=0.004500, step_size=0.000500'
stdout 'Call model_runtime_step\(\) ...'
stdout 'Model: RX\[0084\] Hello from Importer \(10\)'
stdout 'Importer: network message \(RX\): Hello World! from node_id=2'
stdout 'ENVAR:MSG=Foo'
stdout 'ENVAR:TARGET_INST__MSG=Bar'


-- test.sh --
SIMER="${SIMER:-ghcr.io/boschglobal/dse-simer:latest}"
docker run --name simer -i --rm --entrypoint="" --workdir=/repo \
    -v $ENTRYHOSTDIR:/repo \
    -e IMPORTER=$IMPORTER \
    -e FMU_DIR=$FMU_DIR \
    -e SIMBUS_LOGLEVEL=4 \
    $SIMER \
        bash -c "/repo/$IMPORTER --verbose $FMU_DIR"
