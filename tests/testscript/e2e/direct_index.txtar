
env IMPORTER=dse/build/_out/importer/fmuImporter
env FMU_DIR=out/fmu/direct


# SETUP: Construct working folder layout
exec cp -r . $WORKDIR
cd $WORKDIR

# TEST: Build the Simulation and ModelC FMU
env
exec ls -al
exec sh -e build.sh

exists out/fmu/direct.fmu

# TEST: Operate the ModelC FMU
env
exec ls -l out/fmu
exec ls -l out/fmu/direct
exec ls -R -l out/fmu/direct/binaries
exec ls -R -l out/fmu/direct/resources/sim
exec sh -e test.sh

stdout 'Importer: FMU Dir: /workdir/out/fmu/direct'
stdout 'Importer: Loading FMU: binaries/linux64/fmi2modelcfmu.so'
stdout 'Runtime: CWD: /workdir/out/fmu/direct'
stdout 'Load YAML File: resources/sim/data/direct_index.yaml'
stdout 'Model Name: dse.fmi.example.direct'
stdout 'ModelCFmu:   set envar: name=DIRECT__OFFSET, value=100'
stdout 'ModelCFmu:   set envar: name=DIRECT__FACTOR, value=4'
stdout 'Loading dynamic model: resources/sim/model/direct/lib/libdirect.so'
stdout 'Importer: Calling fmi2DoStep\(\): model_time=0.004500, step_size=0.000500'
stdout 'Importer: Simulation return value: 0'
stdout 'Importer:   \[240\] 104.000000'
stdout 'Importer:   \[248\] 108.000000'
stdout 'Importer:   \[256\] 112.000000'
stdout 'Importer:   \[264\] 116.000000'
stdout 'Importer:   \[272\] 120.000000'
stdout 'Importer:   \[280\] 124.000000'
stdout 'Importer:   \[288\] 128.000000'
stdout 'Importer:   \[296\] 132.000000'
stdout 'Importer:   \[304\] 136.000000'
stdout 'Importer:   \[312\] 140.000000'


-- simulation.dse --
simulation
channel in
channel out

uses
dse.fmi file:///repo

model direct dse.fmi.example.direct
    channel in in_vector
    channel out out_vector
    envar OFFSET 100
    envar FACTOR 4

workflow generate-modelcfmu
    var FMU_NAME direct
    var FMI_VERSION 2
    var INDEX direct


-- build.sh --
SIMULATION_DSE="${SIMULATION_DSE:-simulation.dse}"
BUILDER_IMAGE="${BUILDER_IMAGE:-ghcr.io/boschglobal/dse-builder:latest}"
FMI_IMAGE="${FMI_IMAGE:-ghcr.io/boschglobal/dse-fmi:latest}"

env
pwd
echo "==========================="

docker run --name builder -i --rm \
    --user "$(id -u):$(id -g)" \
    -v $ENTRYWORKDIR:/workdir \
    -v $ENTRYHOSTDIR:/repo \
    -e AR_USER -e AR_TOKEN -e GHE_USER -e GHE_TOKEN -e GHE_PAT \
    -e http_proxy -e https_proxy -e no_proxy \
    $BUILDER_IMAGE "$SIMULATION_DSE"
echo "==========================="
echo "==========================="
cat simulation.yaml
echo "==========================="
echo "==========================="
cat Taskfile.yml
echo "==========================="
echo "==========================="

task -y -v

echo "==========================="
echo "==========================="
cat out/fmu/direct/resources/sim/model/direct/data/model.yaml
echo "==========================="
echo "==========================="
cat out/fmu/direct/resources/sim/model/direct/data/signalgroup.yaml
echo "==========================="
echo "==========================="
cat out/fmu/direct/resources/sim/data/direct_index.yaml
echo "==========================="
echo "==========================="
exit 0 # Set to 1 for debug of build stage.

-- test.sh --
SIMER_IMAGE="${SIMER_IMAGE:-ghcr.io/boschglobal/dse-simer:latest}"

echo "==========================="
echo "-- parameters ------"
echo "pwd=$(pwd)"
echo SIMER_IMAGE=$SIMER_IMAGE
echo ENTRYHOSTDIR=$ENTRYHOSTDIR
echo ENTRYWORKDIR=$ENTRYWORKDIR
echo IMPORTER=$IMPORTER
echo FMU_DIR=$FMU_DIR
echo "ls /workdir/$FMU_DIR"
ls /workdir/$FMU_DIR
ls -R /workdir/$FMU_DIR/resources/sim
echo "==========================="
echo "==========================="
cat out/fmu/direct/resources/sim/data/simulation.yaml
echo "==========================="
cat out/fmu/direct/resources/sim/data/direct_index.yaml
echo "==========================="
cat out/fmu/direct/resources/sim/model/direct/data/model.yaml
echo "==========================="
cat out/fmu/direct/resources/sim/model/direct/data/signalgroup.yaml
echo "==========================="
echo "==========================="

docker run --name simer -i --rm --entrypoint="" --workdir=/repo \
    -v $ENTRYHOSTDIR:/repo \
    -v $ENTRYWORKDIR:/workdir \
    -e IMPORTER=$IMPORTER \
    -e FMU_DIR=$FMU_DIR \
    -e SIMBUS_LOGLEVEL=4 \
    $SIMER_IMAGE \
        bash -c "/repo/$IMPORTER \
            --verbose \
            --csv=/workdir/$FMU_DIR/resources/sim/model/direct/data/in_values.csv \
            /workdir/$FMU_DIR"
